# 아키텍처 결정 기록 (Archive: ADR-021~030)

> 활성 ADR: [decisions.md](./decisions.md)
> 이전 아카이브: [decisions_011_020.md](./decisions_011_020.md) (ADR-011~020)

---

## ADR-021: app.js 모듈 분할 + CSS @media 인라인 배치

> 날짜: 2026-02-13 | 상태: 적용 완료

### 맥락

`app.js`가 단일 파일 757줄, 34함수로 구성. 테마 함수 하나를 수정해도 전체 757줄을 읽어야 하며, 에이전트 작업 시 토큰 비효율 발생.

### 결정

**JS**: `app.js`를 7개 모듈로 분할. ES modules 불사용, 전역 함수 + `<script>` 태그 순서 로딩.

| 모듈 | 역할 | 의존 |
|------|------|------|
| `utils.js` | 상수 + 범용 유틸리티 | 없음 |
| `theme.js` | 테마/다크모드 | THEME_KEY (utils) |
| `exclude.js` | 번호 제외 기능 | EXCLUDED_KEY (utils) |
| `lottery.js` | 추첨 로직 + 결과 표시 | copyToClipboard (utils) |
| `history.js` | 이력 관리 (Local + Supabase) | STORAGE_KEY, MAX_HISTORY, generateUUID, showToast (utils) |
| `auth.js` | 인증 (Supabase) | showToast (utils), displayHistory (history) |
| `app.js` | 진입점 (메인 함수 + 초기화) | 전부 |

**Node.js 테스트 호환**: `app.js`에서 `require` → `Object.assign(global, utils)` → 다른 모듈 require → 통합 export.

**CSS**: 파일 하단 단일 `@media` 블록을 각 컴포넌트 바로 아래에 인라인 배치. CSS 변수 블록(:root + dark) 연속 배치.

### 사유

- **토큰 효율**: 테마 수정 시 ~70줄만 읽기 (기존 757줄 → 91% 절감)
- **단순성 원칙 준수**: import/export 없이 script 태그 순서로 의존성 해결
- **순환 의존 없음**: 의존 그래프가 DAG 구조

### 검증 결과

- `npm test`: 23 CLI + 50 DOM = 73 테스트 전부 PASS
- 기존 테스트 코드 수정 0줄 (test-logic.js, test-dom.js 변경 없음)

---

## ADR-022: A-Tier2 Agent 3 경량화 — 교차 검증 위임

**날짜**: 2026-02-13
**상태**: 적용 완료
**관련 커밋**: `0662117`

### 맥락

릴리스 전 전수 검증(A+B+C+D Tier 2, 9 에이전트) 실행 결과, A-Tier2 Agent 3(CLAUDE.md + README.md 검증)이 병목으로 확인되었다.

| 지표 | A3 | 9개 평균 | 배율 |
|------|---:|--------:|-----:|
| Tool 호출 | 22회 | 11.8회 | 1.9x |
| 소요시간 | 107s | 58.9s | 1.8x |
| 토큰 | 48,665 | 41,662 | 1.2x |

**병목 원인**: A3가 함수 카운트(Grep), 테스트 수 확인(Read), 파일 존재(Glob), package.json 검증 등을 **독자적으로** 수행하면서 Tool 호출이 과다하게 발생. 이 중 상당수는 다른 에이전트가 이미 읽는 파일에서 수행 가능한 작업이었다.

### 결정

#### 1. 교차 검증 위임 (A3 → A1, A5)

A3에서 다른 에이전트가 이미 읽는 파일과 겹치는 검증 항목을 위임한다.

| 위임 항목 | 기존 담당 | 신규 담당 | 근거 |
|-----------|----------|----------|------|
| 함수 카운트(34개) | A3 (Grep js/) | **A1** | A1이 tech.md + js/*.js 이미 읽음 |
| 테스트 수(73=23+50) | A3 (Read test/README.md) | **A5** | A5가 test/README.md 이미 읽음 |
| package.json 스크립트 | A3 (Read package.json) | **A5** | A5가 package.json 이미 읽음 |
| 파일 존재 (Glob) | A3 (Glob) | **A1** | A1이 tech.md 파일 구조 이미 검증 |

**A3 잔여 범위**: CLAUDE.md 파일 타입 분류 테이블(Glob) + README.md 내용 정확성

#### 2. A3 프롬프트 최적화

| 기법 | 내용 | 효과 |
|------|------|------|
| 기대값 명시 | js/ 모듈 7개, 파일 타입 분류 수를 프롬프트에 포함 | 탐색 Grep 제거 |
| 배치 가이드 | CLAUDE.md + README.md 병렬 Read → Glob 1~2회 → 완료 | Tool 호출 최소화 |
| 범위 명시 | "API 테이블 검증은 A1 담당" 등 비범위 명시 | 불필요 탐색 방지 |

#### 3. A1, A5 확장

| 에이전트 | 추가 비교 소스 | 추가 검증 항목 |
|----------|-------------|-------------|
| A1 | CLAUDE.md(API 테이블) | 함수 목록 34개가 tech.md와 이름·개수 일치하는지 |
| A5 | CLAUDE.md(수치) | 테스트 수 기대값(73) + package.json 스크립트 참조 일치 |

### 사유

- **병목 해소**: A3가 9개 에이전트 중 유일한 이상치(1.8x 시간)였고, 원인은 다른 에이전트와 중복되는 파일 탐색
- **토큰 중립**: A3 감소(-14K) ≈ A1 증가(+7.6K) + A5 증가(+3.7K). 총 토큰은 -3% 소폭 감소
- **소스 겹침 최소화**: A1은 이미 js/*.js를 읽으므로 CLAUDE.md API 테이블 1개 추가(겹침 ≤1). A5는 이미 package.json을 읽으므로 CLAUDE.md Grep 1회 추가

### 검증 결과

최적화 전후 실측 비교 (Sonnet 모델, 릴리스 전 전수 검증):

**A3 (핵심 대상)**:

| 지표 | 최적화 전 | 최적화 후 | 개선 |
|------|----------:|----------:|-----:|
| 토큰 | 48,665 | 34,504 | **-29%** |
| Tool 호출 | 22회 | 8회 | **-64%** |
| 소요시간 | 107s | 27s | **-75%** |

**전체 시스템**:

| 지표 | 최적화 전 | 최적화 후 | 개선 |
|------|----------:|----------:|-----:|
| 총 토큰 | 374,959 | 364,046 | **-2.9%** |
| 총 Tool 호출 | 106회 | 72회 | **-32%** |
| Wall time 중앙값 | ~107s | ~74s | **-31%** |

**A1 분산 검증** (동일 프롬프트 4회 실행):
- 소요시간: 41s, 69s, 104s, 108s (σ=27s) → A1은 분산 문제이며 구조적 병목 아님 확인

### 검토한 대안

- **A3 분할 (A3a + A3b)**: CLAUDE.md / README.md 각각 별도 에이전트. 고정 오버헤드 2배(~20K) 증가하여 토큰 비효율
- **A3 프롬프트 최적화만**: 위임 없이 기대값 명시 + 배치 가이드만 적용. Tool 호출은 줄지만 소스 겹침(js/ Grep)이 A1과 중복 유지
- **A3 폐지 (A1+A5 흡수)**: A3 범위를 완전히 A1과 A5에 분배. A3 잔여 범위(파일 타입 테이블 + README.md)가 ~25K로 최소 작업량 기준 경계에 있어 유지 결정

---

## ADR-023: B-Tier2 에이전트 Bash 금지 — Read/Grep 전환

**날짜**: 2026-02-13
**상태**: 적용 완료
**관련 커밋**: `30fea1d`

### 맥락

ADR-022 적용 후 전수 검증(A+B+C+D Tier 2, 9 에이전트) 재실행 결과, B-Tier2(design.md ↔ style.css)가 새로운 병목으로 부상하였다.

| 지표 | B | 9개 평균 | 배율 |
|------|--:|--------:|-----:|
| Tool 호출 | 49회 | 12.1회 | 4.0x |
| 소요시간 | 289s | 41.0s | 7.0x |
| 토큰 | 52,917 | 43,384 | 1.2x |

**병목 원인**: B 에이전트가 CSS 변수 비교를 위해 Bash(grep/sed/diff/sort/wc)를 49회 호출. 파이프 조합으로 임시 파일 생성 → diff → 삭제 패턴을 반복하여 Tool 호출 오버헤드(~5-6s/회)가 누적되었다. 토큰 자체는 평균 수준(1.2x)으로, 시간 병목의 원인은 순수하게 Tool 호출 횟수였다.

### 결정

#### 1. Bash 금지 규칙

B-Tier2 프롬프트에 **Bash 사용 금지** 규칙 명시. Bash(grep/sed/diff) 대신 Read + Grep 도구만 사용하도록 제한.

| 기존 방식 | 신규 방식 |
|----------|----------|
| `grep -E "..." style.css \| sed ... \| sort -u` (Bash) | `Read(style.css)` → 모델이 직접 비교 |
| `diff .temp_a.txt .temp_b.txt` (Bash, 임시 파일) | `Read(design.md)` + `Read(style.css)` → 모델 내 교차 비교 |
| `sed -n '/selector/,/}/p' style.css` (Bash) | `Grep(pattern, style.css)` |

#### 2. 배치 가이드 + 기대값 명시

| 기법 | 내용 | 효과 |
|------|------|------|
| 배치 가이드 | design.md + style.css 병렬 Read(2회) → Grep 교차 검증 → 완료 | Tool 호출 최소화 |
| 기대값 명시 | CSS 변수 고유 42개, :root 42개, dark 19개, keyframes 4개, 480px | 탐색 Grep 제거 |
| Bash 금지 | "Bash 사용 금지" 프롬프트 명시 | 파이프라인 패턴 방지 |

### 사유

- **Tool 호출 오버헤드 지배적**: 토큰은 평균 1.2x인데 시간은 7.0x → 차이의 원인은 Tool 호출 횟수(49회 × ~5-6s)
- **Read가 Bash보다 효율적**: CSS 파일 전체를 1회 Read하면 모델이 내부적으로 비교 가능. Bash 파이프라인은 같은 파일을 부분적으로 여러 번 접근
- **임시 파일 제거**: Bash diff 패턴에서 필요했던 임시 파일(.temp_*.txt) 생성/삭제 사이클 완전 제거

### 검증 결과

최적화 전후 실측 비교 (Sonnet 모델):

**B-Tier2 (핵심 대상)**:

| 지표 | 최적화 전 | 최적화 후 | 개선 |
|------|----------:|----------:|-----:|
| 토큰 | 52,917 | 37,474 | **-29%** |
| Tool 호출 | 49회 | 3회 | **-94%** |
| 소요시간 | 289s | 24s | **-92%** |
| Bash 사용 | 22+회 | 0회 | **100% 제거** |

**전체 시스템 예측** (B 최적화 적용 시):

| 지표 | 최적화 전 | 예측 | 개선 |
|------|----------:|-----:|-----:|
| 총 Tool 호출 | 109회 | ~63회 | **-42%** |
| Wall time (병목) | 289s (B) | ~56s (C) | **-81%** |

### 검토한 대안

- **B 에이전트 분할 (B1 + B2)**: 변수 비교 / 컴포넌트 비교 분리. 고정 오버헤드 2배(~20K) 증가, 각각 ~17K로 최소 작업량(25K) 미달
- **Bash 허용 + 호출 수 제한**: "Bash 10회 이내" 지시. 에이전트가 제한을 준수하지 않을 위험 + Read 대비 여전히 비효율
- **Bash 파이프라인 최적화**: 여러 grep/sed를 단일 Bash 호출로 합치기. 호출 수는 줄지만 Read/Grep 전환 대비 복잡도 높고 임시 파일 패턴 유지

---

## ADR-024: Tier 2 에이전트 병합 (9→5) + Haiku 혼합

**날짜**: 2026-02-13
**상태**: 적용 완료

### 맥락

ADR-022, ADR-023 최적화 후에도 릴리스 전 전수 검증이 9개 에이전트, ~364K 토큰을 소비하였다. 소스 파일 중복 읽기 분석 결과, 총 토큰의 ~16%가 중복 파일 읽기에, ~25%가 에이전트 고정 오버헤드(~10K/개)에 사용됨을 확인하였다.

**소스 파일 중복 읽기 현황**:

| 파일 | 줄 수 | 읽는 에이전트 | 횟수 | 추정 낭비 |
|------|------:|-------------|:----:|----------:|
| js/*.js (7모듈) | 873 | A1, A2, C | 3 | ~20K |
| style.css | 801 | A1, A4, B | 3 | ~20K |
| index.html | 110 | A1, A2, A4, C | 4 | ~4.5K |
| design.md | 364 | A4, B | 2 | ~5K |
| spec.md | 219 | A2, C | 2 | ~3K |
| test-logic.js | 247 | A5, D1 | 2 | ~3K |
| test-dom.js | 203 | A5, D2 | 2 | ~2.5K |
| **합계** | | | | **~58K** |

### 결정

#### 1. 4건 에이전트 병합 (9→5)

| 병합 | 공유 소스 | 절감 근거 |
|------|----------|----------|
| **A2+C → A2** | spec.md + index.html + js/*.js (100% 겹침) | 중복 ~14.5K + 오버헤드 10K |
| **A4+B → B** | design.md + style.css | 중복 ~15K + 오버헤드 10K |
| **A3+A5 → A3** | CLAUDE.md (섹션) | 중복 ~3K + 오버헤드 10K |
| **D1+D2 → D** | 오버헤드만 | 오버헤드 10K |

**병합 후 구조**:

| 에이전트 | 모델 | 문서 | 비교 소스 |
|----------|------|------|----------|
| A1 | Sonnet | tech.md | js/*.js, style.css, index.html, CLAUDE.md(API) |
| A2 | Sonnet | spec.md | index.html, js/*.js (양방향: 문서 정확성 + 구현 준수 + ARIA) |
| A3 | Sonnet | CLAUDE.md(비API) + README.md + test/README.md | Glob, test files, package.json, CLAUDE.md(수치) |
| B | Sonnet | design.md | style.css, index.html (전수) |
| D | Sonnet | CLI + DOM/UI 테스트 통합 | test-logic.js, test-dom.js, app.js, test.html |

#### 2. 모델 통일 (Sonnet)

전 에이전트 Sonnet 사용. 초기에 A3, D를 Haiku로 운영하였으나, Haiku 오탐(D에서 테스트 미작성 vs 함수 미구현 혼동) 확인 후 정확도 우선으로 Sonnet 통일.

### 사유

- **중복 읽기 제거**: 전체 토큰의 16%(~58K)가 같은 파일을 여러 에이전트가 반복 읽는 데 소비. 특히 A2와 C는 소스 100% 동일
- **고정 오버헤드 절감**: 에이전트 4개 감소 × 10K = ~40K 절감
- **Sonnet 통일**: 초기 Haiku 혼합 운영 후 오탐 확인 → 정확도 우선으로 전 에이전트 Sonnet 통일
- **시간 제약 준수**: 병합으로 개별 에이전트 처리량 증가하나, 파일을 한 번만 읽으므로 예상 wall time +0~16% (20% 제약 이내)

### 실측 결과

**릴리스 전 전수 검증 (Haiku 혼합 시 실측)**:

| 지표 | 최적화 전 (ADR-023 후) | 실측 | 개선 |
|------|----------------------:|-----:|-----:|
| 에이전트 수 | 9 | 5 | **-44%** |
| 총 토큰 | ~364K | 238.6K | **-34%** |
| Wall time | ~56s (C) | 53.0s (B) | **-5%** |
| Tool 호출 | ~63회 | 56회 | **-11%** |

**개별 에이전트 실측 (Haiku 혼합 → Sonnet 통일)**:

| 에이전트 | Haiku 혼합 실측 | Sonnet 추정 | Tool 호출 | 시간 |
|----------|---------------:|-----------:|---------:|-----:|
| A1 (Sonnet) | 54.9K | 55K | 12 | 38.6s |
| A2 (Sonnet) | 39.7K | 40K | 9 | 22.4s |
| A3 (Haiku→Sonnet) | 42.4K | ~55K | 18 | 29.6s |
| B (Sonnet) | 41.7K | 42K | 3 | 53.0s |
| D (Haiku→Sonnet) | 60.0K | ~78K | 14 | 33.7s |
| **합계** | **238.6K** | **~270K** | **56** | **53.0s** |

> Sonnet 추정: Haiku 실측 × 1.3 (경험적 보정계수). A3, D의 정확한 Sonnet 토큰은 차기 실측 시 확인.

### 검토한 대안

- **A2+C 미병합 (3건 병합만)**: 안전하지만 가장 큰 중복(js/*.js 3중 읽기)이 미해소. ~315K (-13%)로 효과 제한적
- **A1+A2+C 메가 병합**: 중복 최대 제거. 그러나 소스 ~2,500줄 + 3방향 검증으로 예상 70-80s → 20% 시간 제약 초과
- **전체 Haiku**: 모든 에이전트에 Haiku 적용. ~30-35% 추가 절감이나 복합 검증(A1, A2, B) 정확도 저하 위험
- **증분 검증 (변경분만)**: 전수 대신 diff 기반 검증. 근본적 토큰 절감이나 릴리스 전 안전망 약화

---

## ADR-025: A3 프롬프트 강화 — 오탐 방지 + 성능 개선

**날짜**: 2026-02-14
**상태**: 적용 완료

### 맥락

ADR-024 이후 첫 전수 검증 실행에서 A3가 유일한 병목 + 유일한 오탐 에이전트로 확인되었다.

| 지표 | A3 실측 | 5개 평균 | 배율 |
|------|--------:|--------:|-----:|
| Tool 호출 | 28회 | 13.8회 | 2.0x |
| 소요시간 | 123.1s | 65.6s | 1.9x |
| 토큰 | 54.0K | 45.2K | 1.2x |
| 오탐 | 5건 | 0건 | — |

**오탐 근본 원인 (2가지)**:
1. **모듈 정의 미명시**: supabase-config.js를 모듈로 오인 → "8개 모듈" 보고 (실제 7개)
2. **DOM 테스트 카운트 규칙 부재**: test.html의 log() 전체(118)나 PASS+FAIL 합산(100)을 혼합 계산 → "78개" 보고 (실제 50개)

**성능 병목 원인**: test 파일 직접 Read + js/ Grep 등 다른 에이전트 범위 침범으로 Tool 호출 과다

### 결정

#### 1. 카운트 규칙 명시

| 항목 | 규칙 | 기대값 |
|------|------|--------|
| js/ 모듈 수 | CLAUDE.md 명시 목록 기준 (supabase-config.js 제외) | 7개 |
| DOM 테스트 수 | 고유 테스트 케이스 수 (PASS/FAIL 1:1 대응, 한쪽만 카운트. log 전체 합산 금지) | 50개 |
| 총 테스트 수 | CLI 23 + DOM 50 | 73개 |

#### 2. 범위 침범 금지 (교차 검증 원칙 강화)

| 금지 패턴 | 담당 에이전트 | 근거 |
|-----------|-------------|------|
| test-dom.js·test.html 직접 Read | D | D가 테스트 파일 전수 검증 |
| js/ Grep 함수 카운트 | A1 | A1이 tech.md + js/*.js 교차 검증 |
| 불필요 탐색 Grep | — | 기대값 대조만 수행 |

#### 3. Tool 호출 예산

| 단계 | Tool | 횟수 |
|------|------|:----:|
| 1 | CLAUDE.md + README.md + test/README.md 병렬 Read | 3 |
| 2 | package.json Read | 1 |
| 3 | Glob (파일 존재 확인) | 1~2 |
| **합계** | | **≤ 8** |

### 사유

- **오탐 원인이 프롬프트 부재**: 모델 능력 한계가 아니라 카운트 규칙·범위 미명시가 원인
- **ADR-022 교차 검증 원칙 미준수**: A3→A1/D 위임된 항목을 A3가 재수행하여 Tool 과다 + 카운트 불일치
- **기대값 대조 패턴**: 탐색(Grep) 대신 Read 후 기대값과 대조만 수행하면 Tool 호출 대폭 감소

### 실측 결과

개선 전후 비교 (Sonnet 모델):

**A3 (핵심 대상)**:

| 지표 | 개선 전 | 개선 후 | 개선 |
|------|--------:|-------:|-----:|
| 토큰 | 54,003 | 23,820 | **-56%** |
| Tool 호출 | 28회 | 6회 | **-79%** |
| 소요시간 | 123.1s | 27.9s | **-77%** |
| 오탐 | 5건 | 0건 | **100% 제거** |

**전체 시스템 (A3 개선 적용 시)**:

| 지표 | 개선 전 | 개선 후 | 개선 |
|------|--------:|-------:|-----:|
| 총 토큰 | 225,933 | 195,750 | **-13%** |
| Wall time (병목) | 123.1s (A3) | ~56s (B) | **-55%** |
| 총 Tool 호출 | 69회 | 47회 | **-32%** |

---

## ADR-026: B·D 에이전트 Tool 예산 제한 — 불필요 탐색 제거

**날짜**: 2026-02-14
**상태**: 적용 완료

### 맥락

ADR-025(A3 개선) 후 2차 전수 검증에서 B와 D가 새로운 병목으로 확인되었다.

| 에이전트 | 시간 | Tool | 토큰 | 배율(평균 대비) |
|----------|-----:|-----:|-----:|---------------:|
| B | 96.1s | 11 | 40.5K | 시간 1.7x |
| D | 56.8s | 10 | 44.2K | 시간 1.0x |
| 5개 평균 | 57.8s | 9.8 | 39.1K | — |

**B 병목 원인**: 배치 가이드가 "3 Read → 완료"이지만, Glob 2회(파일 탐색) + Grep 2회(스팟체크)를 추가로 수행. 파일 경로가 고정(`docs/design.md`, `css/style.css`, `index.html`)인데 Glob으로 탐색하는 것은 낭비.

**D 병목 원인**: 배치 가이드 미명시. Read 5회 + Grep 1회 = 6회가 하한인데 10회 사용. 함수 커버리지 분석에서 js/*.js 개별 Read를 추가로 수행.

### 결정

#### 1. B Tool 예산 ≤ 4회

| 단계 | Tool | 횟수 |
|------|------|:----:|
| 1 | design.md + style.css + index.html 병렬 Read | 3 |
| 2 | 모델 내 전수 비교 (추가 Grep ≤ 1) | 0~1 |
| **합계** | | **≤ 4** |

금지: Glob (경로 고정), 과다 Grep (Read 후 모델 내 비교)

#### 2. D Tool 예산 ≤ 7회

| 단계 | Tool | 횟수 |
|------|------|:----:|
| 1 | test/README.md + test-logic.js + test-dom.js 병렬 Read | 3 |
| 2 | test.html + js/app.js 병렬 Read | 2 |
| 3 | Grep(`^(async )?function`, js/) 함수 목록 | 1 |
| 4 | 모델 내 교차 비교 | 0 |
| **합계** | | **≤ 7** |

금지: js/*.js 개별 Read (함수 목록은 Grep 1회로 충족), Glob (경로 고정)

### 사유

- **B**: ADR-024 기준 3 Tool/53s가 달성 가능한 하한. Glob/Grep 추가가 시간만 증가시키고 검증 품질 향상 없음
- **D**: 함수 커버리지를 위해 js/*.js를 개별 Read하면 A1과 소스 중복. Grep 1회로 함수 목록 확보 가능
- **패턴 일반화**: A3(ADR-025)에서 확인된 "Tool 예산 + 금지 패턴" 조합이 효과적 → B, D에도 동일 적용

### 실측 결과

| 에이전트 | 지표 | 개선 전 | 개선 후 | 개선 |
|----------|------|--------:|-------:|-----:|
| B | Tool | 11회 | 3회 | **-73%** |
| B | 토큰 | 40,473 | 37,076 | **-8%** |
| B | 시간 | 96.1s | 81.1s | **-16%** |
| D | Tool | 10회 | 6회 | **-40%** |
| D | 토큰 | 44,162 | 42,785 | **-3%** |
| D | 시간 | 56.8s | 40.2s | **-29%** |

**전체 시스템 (B+D 개선 적용 시)**:

| 지표 | 개선 전 | 개선 후 | 개선 |
|------|--------:|-------:|-----:|
| 총 토큰 | 195,457 | ~184,733 | **-5.5%** |
| 총 Tool | 49회 | ~37회 | **-24%** |
| Wall time (병목) | 96.1s (B) | ~81s (B) | **-16%** |

> B의 시간이 예상(25-35s)보다 높은 원인: style.css 800줄 + design.md 370줄의 모델 내 전수 비교가 Tool 오버헤드가 아닌 **모델 추론 시간**을 지배. Tool 예산은 하한(3회) 달성했으나 시간은 모델 처리 속도에 의존.

---

## ADR-027: Tier 0 스크립트 전처리 — 기계적 검증 자동화

**날짜**: 2026-02-14
**상태**: 적용 완료
**관련 파일**: `scripts/verify.js`

### 맥락

ADR-026 후 B 에이전트의 Tool 호출은 하한(3회)에 도달했으나, 시간(81s)은 모델 추론에 의해 지배되었다. B가 수행하는 작업의 상당 부분은 "CSS 변수 A의 값이 문서와 CSS에서 동일한가?"와 같은 **기계적 비교**로, LLM이 아닌 스크립트로 수행 가능하다.

**에이전트 작업 분류**:

| 작업 유형 | 예시 | 수행 주체 |
|----------|------|----------|
| 기계적 비교 | CSS 변수값 일치, 함수 카운트, 테스트 카운트 | **스크립트** |
| 의미적 판단 | "문서가 동작을 정확히 기술하는가?", "누락 기능이 있는가?" | **에이전트** |

### 결정

#### 1. `scripts/verify.js` 전처리 스크립트 신설

Node.js 스크립트로 11개 기계적 검증을 자동화:
- CSS 변수: :root 42개 + dark 19개 전수 값 비교 (design.md ↔ style.css)
- keyframes 4개, breakpoint 480px 확인
- 함수 34개 (7모듈, sync 26 + async 8) 카운트
- 테스트 73개 (CLI 23 + DOM 50) 카운트
- 필수 파일 14개 존재 확인

#### 2. `npm run verify` 스크립트 등록

`package.json`에 `"verify": "node scripts/verify.js"` 추가.

#### 3. Tier 0 → Tier 1 → Tier 2 3계층 체계

| 계층 | 방식 | 빈도 | 시간 |
|------|------|------|------|
| **Tier 0** | 스크립트 (기계적) | 모든 변경 시 | < 1s |
| Tier 1 | 에이전트 (스팟체크) | 코드/스타일 변경 시 | ~15-20s |
| Tier 2 | 에이전트 (의미적 전수) | 릴리스 전 | ~55-80s |

### 사유

- **B 병목의 본질**: Tool 오버헤드(해결됨) → 모델 추론 시간(구조적). CSS 변수 42+19개의 값 비교를 모델이 수행할 필요 없음
- **정확도 향상**: 스크립트는 오탐 0 (결정적 비교). 에이전트는 rgba 공백 차이 등에서 오탐 가능
- **에이전트 범위 축소**: B가 CSS 변수 비교를 하지 않으면 style.css 800줄을 읽을 필요가 줄어들거나, 읽더라도 의미적 검증에만 집중 가능

### 실측 결과

스크립트 실행: **11/11 PASS, < 1초**

```
PASS css.root.count: 42/42
PASS css.root.values: all match
PASS css.dark.count: 19/19
PASS css.dark.values: all match
PASS css.keyframes: 4 (pop, fadeIn, slideUp, fadeOut)
PASS css.breakpoints: 480px, 12 media queries
PASS functions.total: 34 (sync 26 + async 8)
PASS tests.cli: 23/23
PASS tests.dom: 50/50
PASS tests.total: 73/73
PASS files: all present
```

---

## ADR-028: A3 오탐 수정 + A2 병목 최적화 — Tier 0 ARIA 이관

**날짜**: 2026-02-14
**상태**: 적용 완료
**관련 파일**: `scripts/verify.js`, `docs/verification.md`

### 맥락

ADR-027 Tier 0 도입 후 3차 전수 검증 결과:

| 에이전트 | 시간 | Tool | 토큰 | 이슈 |
|----------|-----:|-----:|-----:|------|
| A1 | 59.2s | 12 | 41.2K | 0 |
| **A2** | **71.9s** | **9** | **32.4K** | 0 (병목) |
| A3 | 26.1s | 6 | 23.5K | 1 오탐 |
| B | 46.2s | 3 | 30.2K | 0 |
| D | 53.2s | 6 | 32.2K | 0 |

**A3 오탐**: CLAUDE.md `lottery.js(4) | app.js(2)`를 오류로 보고. 기대값 `lottery.js(5) | app.js(1)`. 실제로는 generateLottoNumbers 물리적 위치 반영으로 의도적 변경 (ADR-025 이후).

**A2 병목 원인**: 9개 파일 Read (spec.md + index.html + 7 JS 모듈). 검증 3(ARIA 전수 확인)이 기계적 비교임에도 에이전트가 수행.

### 결정

#### 1. A3 기대값에 모듈별 함수 수 명시

`verification.md` A3 프롬프트에 추가: `모듈별 함수 수 lottery(4) history(8) exclude(7) utils(3) theme(5) auth(5) app(2)`

#### 2. Tier 0에 ARIA/접근성 기계적 검증 추가 (11→13개)

`scripts/verify.js`에 2개 검증 추가:
- `aria.attributes`: spec.md ARIA 테이블 7개 속성의 index.html 존재 확인
- `aria.srOnly`: auth 라벨 sr-only 클래스 2개 확인

#### 3. A2 배치 가이드 + Tool 예산 ≤ 6회

| 단계 | Tool | 횟수 |
|------|------|:----:|
| 1 | spec.md + index.html 병렬 Read | 2 |
| 2 | Grep(`^(async )?function`, js/) 함수 존재 확인 | 1 |
| 3 | Grep으로 F-xxx 핵심 패턴 확인 | 1~2 |
| 4 | 모델 내 교차 비교 | 0 |
| **합계** | | **≤ 6** |

금지: js/*.js 7개 개별 Read, Glob, ARIA 수동 확인 (Tier 0 위임)

### 사유

- **A3 오탐 근본 원인**: 모듈별 함수 수 기대값이 프롬프트에 없어 독자 판단 → 의도적 변경을 오류로 분류
- **A2 검증 3(ARIA)의 기계적 성격**: "id=X에 attr=Y가 있는가?"는 정규식으로 결정적 확인 가능, LLM 불필요
- **A2 파일 읽기 최소화**: 9개 Read → 2 Read + 2~3 Grep으로 js/ 전체 Read 제거. 특정 패턴만 타겟 검증

### 실측 결과

Tier 0: 13/13 PASS (< 1s). Tier 2 에이전트 5개 병렬 실행 (Sonnet):

| 에이전트 | 시간 | Tool | 토큰 | 이슈 |
|----------|-----:|-----:|-----:|------|
| A1 | 36.4s | 9 | 38.7K | 0 |
| A2 | 98.1s | 7 | 36.8K | 0 |
| A3 | 42.4s | 7 | 27.6K | 1 오탐 |
| B | 29.1s | 3 | 33.8K | 0 |
| D | 47.5s | 6 | 42.7K | 0 |

**A2 Tool 감소**: 9→7회 (-22%). ARIA 검증 생략 + js/ 개별 Read 제거 효과.
**A2 시간 증가**: 71.9s→98.1s (+36%). Tool 감소에도 시간 증가 — **모델 추론 분산**이 지배적. 구조적 최적화 한계.
**A3 오탐 1건**: app.js 함수 수를 1개로 오해 (실제 2개). Tier 0 데이터 해석 오류 — 프롬프트에 기대값이 명시되어 있으나 모델이 Tier 0 보고를 오독.

**이전 대비** (3차 vs 4차):

| 지표 | 3차 | 4차 | 변화 |
|------|----:|----:|-----:|
| 총 토큰 | 159.5K | 179.6K | +13% |
| 총 Tool | 36 | 32 | **-11%** |
| Wall time | 71.9s | 98.1s | +36% |

> Tool 감소에도 토큰/시간 증가: 모델 추론 분산(특히 A2)이 원인. A2의 시간은 모델 호출 타이밍에 따라 30~100s 범위에서 변동.

---

## ADR-029: 에이전트 프롬프트 추상화 + verify.js 동적 비교

**날짜**: 2026-02-14
**상태**: 적용 완료
**관련 파일**: `scripts/verify.js`, `docs/verification.md`

### 맥락

verification.md의 에이전트 프롬프트가 구체적 기대값(34함수, 42 CSS변수, 73테스트 등)을 하드코딩하고 있어:
- 코드 변경 시 프롬프트 연쇄 수정 필요 (유지보수 비용)
- 하드코딩 값이 실제와 불일치 시 오탐 발생 (A3의 반복적 오탐이 대표 사례)
- 프롬프트가 "무엇이 맞는지"가 아닌 "어떻게 검증하는지"를 기술해야 함

verify.js도 `=== 42`, `=== 34` 같은 매직 넘버를 사용하여 문서 변경 시 스크립트도 수정이 필요하였다.

### 결정

#### 1. 3단계 추상화 수준 분류

| 수준 | 설명 | 예시 | 판정 |
|------|------|------|------|
| L1 순수 행위 | 도구 사용 전략 | "병렬 Read 후 모델 내 비교" | 유지 |
| L2 역할 바인딩 | 에이전트 담당 파일 | "A2는 spec.md를 검증" | 유지 |
| L3 스냅샷 데이터 | 특정 시점의 수치 | "함수 34개, CSS 42개" | **제거** |

#### 2. verify.js 매직 넘버 → 동적 비교

| 기존 (하드코딩) | 전환 후 (동적) | 파서 |
|----------------|---------------|------|
| `cssRoot.length === 42` | `cssRoot.length === docRoot.length` | 기존 |
| `cssDark.length === 19` | `cssDark.length === docDark.length` | 기존 |
| `keyframes.length === 4` | `cssKeyframes === docKeyframes` | design.md 신규 |
| `functions.total === 34` | `grepCount === claudeMdCount` | CLAUDE.md 신규 |
| `tests.cli === 23` | `itCount === readmeCliCount` | test/README.md 신규 |
| `tests.dom === 50` | `passCount === readmeDomCount` | test/README.md 신규 |
| `aria expected 배열` | spec.md ARIA 테이블 파싱 | spec.md 신규 |
| `srOnly expected 배열` | HTML auth-input 동적 발견 | HTML 동적 |
| `files expected 배열` | README.md 파일 트리 파싱 | README.md 신규 |

신규 파서 5개: `parseDesignKeyframes`, `parseClaudeMdModules`, `parseTestReadmeCounts`, `parseSpecAriaTable`, `parseReadmeFileTree`

#### 3. verification.md 에이전트 프롬프트 추상화

- 모든 L3 수치(34, 42, 73 등)를 프롬프트에서 제거
- 행위 기반 기술로 교체: "문서에서 값을 추출하여 소스와 비교"
- Tool 호출 횟수 예산 제거 → "최소 Tool로 수행" 원칙

#### 4. 변경하지 않는 것

- CLAUDE.md 모듈 테이블 (빠른 참조용)
- 역할 바인딩 (L2, 어떤 에이전트가 어떤 파일 담당)
- 금지 패턴/제약 (행위 규칙)
- 카운트 방법론 (Grep 패턴, PASS/FAIL 규칙)

### 사유

- **A3 반복 오탐**: ADR-025, ADR-028에서 기대값을 명시했으나, 하드코딩 값 자체가 코드 변경 시 불일치 → 근본 원인은 기대값 하드코딩
- **유지보수 비용**: 함수 1개 추가 시 verify.js + verification.md + CLAUDE.md 3곳 수정 필요 → verify.js + CLAUDE.md만 (verification.md 수정 불필요)
- **Tier 0 활용**: 기계적 카운트는 Tier 0이 담당, 에이전트는 의미적 검증에 집중

### 검증 결과

verify.js 동적 비교: **13/13 PASS** (매직 넘버 전환 후 동일 결과)

---

## ADR-030: A2 에이전트 Grep→병렬Read 전략 전환

**날짜**: 2026-02-14
**상태**: 적용 완료
**관련 파일**: `docs/verification.md`

### 맥락

A2 에이전트(spec.md ↔ 소스코드)가 다른 에이전트 대비 성능이 현저히 낮았다:

| 지표 | A2 (원본) | A3 (기준) | 배율 |
|------|----------|-----------|------|
| Tool 호출 | 24 | 12 | 2.0x |
| 경과 시간 | 90.0s | 45.5s | 1.98x |
| 토큰 | 30.7K | 29.4K | 1.04x |

**핵심 발견**: 토큰량은 4% 차이인데 시간은 2배 → **병목은 API 왕복(Round Trip) 횟수**.

### 원인 분석

A2의 기존 전략(ADR-028):
- 금지 패턴: `js/*.js 7개 개별 Read 금지 — Grep으로 타겟 검증`
- 배치 가이드: `spec.md + index.html Read → Grep으로 기능별 구현 확인`

이 규칙이 F-001~F-008 각 기능마다 **개별 Grep을 순차 호출**하게 만들어:
- 기능당 2~3개 Grep × 8개 기능 = ~20 Grep 호출
- 독립적인 Grep도 병렬화하지 않고 순차 실행 → RT 12회 이상

반면 A3는 "Grep 금지 — 문서에서 추출한 값으로 대조만" 규칙 덕분에 Read 위주로 처리하여 효율적.

### 결정

#### 1. 배치 가이드 변경

```
기존: spec.md + index.html Read → Grep으로 기능별 구현 확인
변경: spec.md + index.html + js/*.js를 병렬 Read → 모델 내 양방향 비교
```

#### 2. 금지 패턴 변경

```
기존: js/*.js 7개 개별 Read 금지 — Grep으로 타겟 검증
변경: 기능별 Grep 순차 호출 금지 — Read 후 모델 내 비교 우선
```

#### 3. Tool 상한은 미설정

실측으로 Tool 상한(≤10) 유무에 따른 차이가 0.5초(59.1s vs 58.6s)로 무의미. Read 기반 전략 지정만으로 모델이 자연스럽게 10~11회에 수렴.

### 사유

- **RT 감소가 핵심**: Read로 파일을 한 번에 읽고 모델 내 비교 → Grep 순차 호출 대비 RT 12+→3으로 감소
- **정확도 부수 효과**: 원본 A2는 `matchMedia` 리스너를 theme.js에서만 찾아 "미구현" 오탐. 최적화 A2는 app.js도 Read하여 정확히 발견 → **오탐 1→0건**
- **토큰 트레이드오프 허용**: 파일 전체 Read로 입력 토큰 증가(30.7K→41.4K)하지만, verification.md 예상치(~40K)와 일치하며 시간 34% 단축이 상쇄

### 실측 결과

3가지 변형 비교 (모델: Sonnet):

| 변형 | Tool | 시간 | 토큰 | 정확도 |
|------|-----:|-----:|-----:|--------|
| 원본 (Grep 기반) | 24 | 90.0s | 30.7K | 오탐 1건 |
| ≤10 제한 (Read 기반) | 10 | 59.1s | 41.4K | 0건 |
| 무제한 (Read 기반) | 11 | 58.6s | 44.7K | 0건 |

**최종 적용 후 전수 검증** (5개 에이전트 병렬):

| 에이전트 | Tool | 토큰 | 시간 | Warning |
|----------|-----:|-----:|-----:|---------|
| A1 | 11 | 47.7K | 49.8s | 0 |
| **A2** | **10** | **34.9K** | **38.8s** | **0** |
| A3 | 12 | 29.1K | 40.2s | 0 |
| B | 3 | 31.3K | 28.9s | 0 |
| D | 6 | 41.1K | 44.6s | 0 |

A2 개선 요약: Tool **-58%** (24→10), 시간 **-57%** (90.0→38.8s), 오탐 제거.
