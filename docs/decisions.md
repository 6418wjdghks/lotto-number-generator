# 아키텍처 결정 기록 (Architecture Decision Records)

프로젝트의 주요 설계 결정과 그 사유를 기록합니다.

> 과거 ADR: [decisions_001_010.md](./decisions_001_010.md) (ADR-001~010)

---

## 목차

| # | 결정 | 상태 | 날짜 |
|---|------|------|------|
| [011](#adr-011) | 문서 중복 제거 리팩토링 | 적용 완료 | 2026-02-11 |
| [012](#adr-012) | phase4-plan → phase4-architecture 이름 변경 | 적용 완료 | 2026-02-11 |
| [013](#adr-013) | 번호 제외 UI: 토글 버튼 그리드 | 유지 | 2026-02-11 |
| [014](#adr-014) | 2계층 테스트 아키텍처 (CLI + 브라우저) | 유지 | 2026-02-11 |
| [015](#adr-015) | 파생 수치 단일 소스 규칙 | 유지 | 2026-02-11 |
| [016](#adr-016) | Supabase REST API 직접 호출 (SDK 미사용) | 유지 | 2026-02-12 |
| [017](#adr-017) | 문서 전면 구조 개편 — 토큰 사용량 48% 감소 | 적용 완료 | 2026-02-12 |
| [018](#adr-018) | DOM/UI 테스트 CLI 러너 (puppeteer-core + Edge headless) | 유지 | 2026-02-13 |
| [019](#adr-019) | 다크 모드: `html[data-theme]` + FOUC 방지 인라인 스크립트 | 유지 | 2026-02-13 |
| [020](#adr-020) | 검증 체계: Label 기반 매핑 + 에이전트 품질 규칙 | 적용 완료 | 2026-02-13 |
| [021](#adr-021) | app.js 모듈 분할 + CSS @media 인라인 배치 | 적용 완료 | 2026-02-13 |
| [022](#adr-022) | A-Tier2 Agent 3 경량화 — 교차 검증 위임 | 적용 완료 | 2026-02-13 |

---

## ADR-011: 문서 중복 제거 리팩토링

**날짜**: 2026-02-11
**상태**: 적용 완료

### 맥락
프로젝트 문서 7개 파일에서 14개 중복 항목이 발견되었다. 특히 CLAUDE.md(~380줄)는 매 세션 로드되어 토큰 낭비가 심했다.

### 결정
"단일 진실 소스(Single Source of Truth)" 원칙을 적용. 각 문서에 명확한 역할을 부여하고, 중복 내용은 원본 참조로 대체.

### 결과
전체 문서 1,898줄 → 1,163줄 (39% 감소)

---

## ADR-012: phase4-plan → phase4-architecture 이름 변경

**날짜**: 2026-02-11
**상태**: 적용 완료
**관련 커밋**: `4c1e7b1`

### 맥락
`docs/phase4-plan.md`와 `docs/plan.md`가 이름만 보면 둘 다 "계획" 문서로 보였다. 실제로는 역할이 완전히 달랐다.

### 결정
`phase4-plan.md` → `phase4-architecture.md`로 이름 변경. plan = 진행 관리, architecture = 기술 설계.

---

## ADR-013: 번호 제외 UI: 토글 버튼 그리드

**날짜**: 2026-02-11 (Phase 3, Step 4)
**상태**: 유지
**명세**: `docs/spec.md` F-005

### 맥락
F-005 수동 번호 제외 기능에서 사용자가 제외할 번호를 선택하는 UI 방식을 정해야 했다.

### 결정
1~45 숫자를 9열 그리드의 토글 버튼으로 표시한다. 클릭하면 제외/해제가 토글된다.

### 사유
- **직관성**: 숫자를 보면서 바로 클릭. 입력값 검증이 불필요
- **터치 친화적**: 모바일에서 버튼 탭이 텍스트 입력보다 편리
- **시각적 피드백**: 제외된 번호가 즉시 회색 + 취소선으로 표시
- **기존 UI와 일관성**: 이력 섹션과 동일한 접이식(토글) 패턴 재사용

### 검토한 대안
- **체크박스 목록**: 45개 체크박스를 나열. 공간을 많이 차지하고 시각적 매력이 낮음
- **텍스트 입력**: 콤마로 구분된 숫자 직접 입력. 컴팩트하지만 입력 검증이 복잡하고 오타 위험

---

## ADR-014: 2계층 테스트 아키텍처 (CLI + 브라우저)

**날짜**: 2026-02-11
**상태**: 유지

### 맥락
기존 테스트(`test/test.html`)는 브라우저에서만 실행 가능하여 자동화가 어려웠다.

### 결정
2계층 테스트 구조를 도입한다:
- **계층 1** (`test/test-logic.js`): Node.js `node:test`로 순수 로직 테스트 (CLI 실행)
- **계층 2** (`test/test.html`): 브라우저에서 DOM/UI 테스트 (기존 유지)

### 사유
- **CI 연동**: `node --test test/test-logic.js`로 exit code 0/1 반환
- **외부 의존성 없음**: Node.js 18+ 내장 `node:test` 사용
- **빠른 피드백**: CLI 테스트는 브라우저 없이 즉시 실행 (~1초)
- **관심사 분리**: 순수 로직은 CLI, DOM 의존 기능은 브라우저

### app.js 호환성
```javascript
if (typeof module !== 'undefined' && module.exports) {
  module.exports = { ... };
}
```

---

## ADR-015: 파생 수치 단일 소스 규칙

**날짜**: 2026-02-11
**상태**: 유지

### 맥락
문서 점검 결과 17건의 명세-구현 불일치가 발견되었다. 근본 원인 중 하나가 코드에서 파생되는 수치(함수 수, 테스트 수)가 여러 문서에 중복 기록된 것이었다.

### 결정
코드에서 파생되는 수치는 단일 소스에만 기록한다.

| 수치 | 단일 소스 | 다른 문서 |
|------|----------|---------|
| 함수 목록/수 | CLAUDE.md API 테이블 | "CLAUDE.md 참조" |
| 테스트 수/항목 | test/README.md | "test/README.md 참조" |
| 파일 줄 수 | 기록하지 않음 | - |

---

## ADR-016: Supabase REST API 직접 호출 (SDK 미사용)

**날짜**: 2026-02-12 (Phase 4)
**상태**: 유지
**코드**: `js/supabase-config.js`

### 맥락
Phase 4에서 Supabase를 백엔드로 도입할 때, SDK(`@supabase/supabase-js`)를 사용할지, 순수 `fetch()` + REST API로 직접 호출할지 결정해야 했다.

### 결정
순수 `fetch()` + Supabase REST API를 직접 호출한다. API 래퍼를 `js/supabase-config.js`에 IIFE로 구현하고 `window.supabase` 전역 객체로 노출.

### 사유
- **ADR-001 일관성**: "순수 JavaScript만 사용 — 프레임워크/라이브러리 금지" 원칙 유지
- **빌드 불필요**: 브라우저 내장 `fetch()`만 사용
- **학습 가치**: REST API 직접 호출로 HTTP 인증 흐름 이해
- **번들 크기 0**: SDK(~40KB gzip) 불필요

### 제약사항
- **토큰 갱신 미구현**: 세션 만료 시 재로그인 필요. 필요 시 추후 추가
- **세션 보안**: access_token을 LocalStorage에 저장 (Supabase SDK도 동일 방식)

### 재검토 조건
실시간 기능, 파일 스토리지, OAuth 등이 필요해지면 SDK 도입 재검토

---

## ADR-017: 문서 전면 구조 개편 — 토큰 사용량 48% 감소

**날짜**: 2026-02-12
**상태**: 적용 완료

### 맥락
매 세션 CLAUDE.md(211줄)가 자동 로드되고, 작업 시 2~4개 문서를 추가로 읽어야 해서 컨텍스트가 빠르게 차오르는 문제가 있었다. 8개 문서 총 3,919줄.

### 결정
문서 역할을 재정의하고 중복/사문화된 내용을 대폭 제거한다.

### 핵심 변경
1. **spec.md**: JavaScript API/데이터구조 → tech.md 이동. 순수 제품 명세만 유지
2. **tech.md**: spec.md에서 API 흡수, 불필요 섹션(코드 품질, 개발환경, 배포 명령) 제거
3. **design.md**: CSS 코드블록 전량 삭제 → 컴포넌트 명세 테이블로 대체
4. **phase4-architecture.md**: 미채택 아키텍처 옵션(Option 1/2) 삭제
5. **decisions.md**: ADR-001~010 → `decisions_001_010.md` 아카이브
6. **CLAUDE.md**: 파일구조/진행바/Supabase API 제거, 참조 방식 전환

### 사유
- **토큰 절감**: 3,919줄 → ~2,020줄 (48% 감소)
- **역할 명확화**: spec.md = WHAT, tech.md = HOW
- **CSS 중복 제거**: design.md에서 style.css 복사본 ~800줄 삭제
- **사문화 방지**: 미채택 옵션, 완료된 체크리스트 정리

---

## ADR-018: DOM/UI 테스트 CLI 러너 (puppeteer-core + Edge headless)

**날짜**: 2026-02-13
**상태**: 유지
**코드**: `test/test-dom.js`

### 맥락
기존 DOM/UI 테스트(`test/test.html`)는 브라우저에서만 실행 가능하여 CLI에서 결과를 확인할 수 없었다. `npm test` 한 번으로 전체 테스트를 실행할 수 있어야 했다.

### 결정
`puppeteer-core`로 시스템에 설치된 Edge를 headless 모드로 실행하여 `test/test.html`의 테스트 결과를 CLI에 텍스트로 출력한다.

### 사유
- **puppeteer-core** (Chromium 미포함): 번들 크기 ~3MB (puppeteer full ~170MB)
- **Edge 재사용**: Windows 11에 기본 설치된 Edge를 활용. 별도 브라우저 다운로드 불필요
- **test.html 최소 수정**: `console.log` 1줄 + `dataset` 완료 시그널 4줄 + `readText` try-catch 분리. 기존 브라우저 동작 유지
- **HTTP 서버 내장**: `node:http`로 프로젝트 루트를 정적 서빙. file:// 프로토콜 제한 회피
- **CDP 권한 부여**: `Browser.grantPermissions`로 `clipboardReadWrite` 부여. `overridePermissions`는 headless 클립보드 mock을 방해하여 부적합

### 검토한 대안
- **puppeteer (full)**: Chromium 내장. 용량이 크고 이미 Edge가 있으므로 불필요
- **Playwright**: 더 풍부한 API지만, 단순 테스트 러너에는 과도함. 별도 브라우저 설치 필요
- **JSDOM**: DOM 시뮬레이션. CSS 렌더링/시각적 테스트 불가
- **overridePermissions**: headless 모드에서 writeText까지 깨뜨림. CDP 직접 호출로 해결

---

## ADR-019: 다크 모드: `html[data-theme]` + FOUC 방지 인라인 스크립트

**날짜**: 2026-02-13
**상태**: 유지
**명세**: `docs/spec.md` F-008

### 맥락
Phase 3 미착수 항목인 다크 모드를 구현해야 했다. 현재 모든 색상이 CSS 변수(`:root`)로 관리되어 있어, 변수를 오버라이드하는 방식으로 전체 앱을 전환할 수 있었다.

### 결정
1. **테마 선택자**: `html[data-theme="dark"]` — `:root`보다 특이성이 높아 변수 오버라이드가 자연스러움
2. **저장**: LocalStorage 키 `lotto_theme` (기존 `lotto_history`, `lotto_excluded` 패턴 준수)
3. **FOUC 방지**: `<head>`에서 `<link>` 태그 앞에 인라인 `<script>`로 `data-theme` 설정
4. **우선순위**: LocalStorage > `prefers-color-scheme` > light 기본값

### 사유
- **CSS 변수 활용**: 기존 `:root` 토큰 구조 덕분에 `html[data-theme="dark"]`에서 변수만 재정의하면 전체 UI 전환. 개별 클래스/선택자 추가 불필요
- **FOUC 방지**: CSS 파싱 전에 `data-theme`을 설정하여 다크 모드 사용자에게 밝은 화면이 잠깐 보이는 문제 방지
- **`prefers-color-scheme` 연동**: 저장값이 없을 때만 시스템 설정 반영. `matchMedia` change 리스너로 실시간 감지

### 검토한 대안
- **`body.dark` 클래스**: `body`는 DOM 로드 후 접근 가능하여 FOUC 방지 어려움
- **`:root.dark`**: `:root`와 같은 특이성이라 오버라이드 충돌 가능
- **CSS `@media (prefers-color-scheme)` only**: 사용자가 수동 전환할 수 없음

---

## ADR-020: 검증 체계: Label 기반 매핑 + 에이전트 품질 규칙

**날짜**: 2026-02-13
**상태**: 적용 완료
**관련 커밋**: `2cb4be3`, `cebfa16`, `e864de9`, `36aab8b`, `a721d66`, `60a3cc2`

### 맥락
기존 검증 체계는 "매 변경 시 Tier 1 전체(4 에이전트, ~70K 토큰)"를 실행하는 규칙이었다. style.css만 수정해도 함수 수(A), 구현(C), 테스트(D) 검증이 모두 실행되어 불필요한 토큰 소비가 발생했다. 또한 검증 에이전트에서 반복적인 오탐(카운트 오류, 재위임, 임시 파일 잔류)이 발생했다.

### 결정

#### 1. Label 기반 검증 매핑
변경 파일을 9개 타입 Label로 분류하고, 각 Label에 관련 검증 카테고리만 매핑한다.

| Label | 타입 | Tier 1 | Tier 2 |
|-------|------|--------|--------|
| `style` | 스타일 | B | — |
| `code` | 코드 | A, C | — |
| `test` | 테스트 | D | — |
| `doc:api` | 문서(API) | — | A |
| `doc:design` | 문서(디자인) | — | B |
| `doc:spec` | 문서(명세) | — | C |
| `doc:test` | 문서(테스트) | — | D |
| `doc:track` | 문서(추적) | — | — |
| `config` | 설정 | — | — |

복합 변경 시 합집합(Union). 같은 카테고리에 T1+T2 → T2만 실행.

#### 2. 에이전트 프롬프트 품질 규칙

| 규칙 | 내용 | 미적용 시 문제 |
|------|------|---------------|
| 카운트 규칙 명시 | 기대값 + 카운트 방법을 프롬프트에 포함 | 중복 카운트, 누락 등 오탐 |
| 재위임 금지 | "Task 도구로 서브에이전트 재생성 금지" | 에이전트 불완전 종료 |
| 임시 파일 RAII | "생성 파일 추적 → 종료 전 삭제" | 프로젝트에 임시 파일 잔류 |
| Bash 명령어 보고 | "사용한 Bash 명령어 목록 출력" | permission 누락 파악 불가 |

#### 3. Permission 패턴화
개별 Bash 명령어 55개를 접두사 패턴 27개로 통합. 로컬 작업은 자동 허용, 외부 연결은 승인 요청.

### 사유
- **토큰 절감**: style.css 변경 시 70K → 15K (−79%), 코드 변경 시 70K → 40K (−43%)
- **오탐 해소**: 카운트 규칙 명시로 A-Tier1(함수 34개), B-Tier1(CSS 변수 42개) 오탐 완전 해소
- **안정성**: 재위임 금지로 A-Tier2-1 불완전 종료 해소, RAII로 임시 파일 잔류 해소
- **Permission 효율**: 55개 → 27개 패턴, 검증 실행 시 권한 요청 0건 달성

### 검증 결과
13 에이전트 릴리스 수준 검증(Tier 1 + Tier 2) 실행:
- 오탐: 0건 (이전 3건 → 0건)
- 권한 요청: 0건
- 재위임 시도: 0건
- 임시 파일 잔류: 0건
- 실제 불일치: design.md 경미 2건 발견 및 수정 (`.toast` #333→#333333, `.set-selector select` solid 추가)

### 검토한 대안
- **Tier 1 전체 유지**: 단순하지만 매 변경 시 ~70K 고정 비용. 관련 없는 카테고리까지 실행
- **검증 안 함**: 토큰 0이지만 문서-코드 불일치 누적 위험
- **Main Agent 직접 검증**: 서브에이전트 오버헤드 없지만 메인 컨텍스트 오염 (~130K)

---

## ADR-021: app.js 모듈 분할 + CSS @media 인라인 배치

> 날짜: 2026-02-13 | 상태: 적용 완료

### 맥락

`app.js`가 단일 파일 757줄, 34함수로 구성. 테마 함수 하나를 수정해도 전체 757줄을 읽어야 하며, 에이전트 작업 시 토큰 비효율 발생.

### 결정

**JS**: `app.js`를 7개 모듈로 분할. ES modules 불사용, 전역 함수 + `<script>` 태그 순서 로딩.

| 모듈 | 역할 | 의존 |
|------|------|------|
| `utils.js` | 상수 + 범용 유틸리티 | 없음 |
| `theme.js` | 테마/다크모드 | THEME_KEY (utils) |
| `exclude.js` | 번호 제외 기능 | EXCLUDED_KEY (utils) |
| `lottery.js` | 추첨 로직 + 결과 표시 | copyToClipboard (utils) |
| `history.js` | 이력 관리 (Local + Supabase) | STORAGE_KEY, MAX_HISTORY, generateUUID, showToast (utils) |
| `auth.js` | 인증 (Supabase) | showToast (utils), displayHistory (history) |
| `app.js` | 진입점 (메인 함수 + 초기화) | 전부 |

**Node.js 테스트 호환**: `app.js`에서 `require` → `Object.assign(global, utils)` → 다른 모듈 require → 통합 export.

**CSS**: 파일 하단 단일 `@media` 블록을 각 컴포넌트 바로 아래에 인라인 배치. CSS 변수 블록(:root + dark) 연속 배치.

### 사유

- **토큰 효율**: 테마 수정 시 ~70줄만 읽기 (기존 757줄 → 91% 절감)
- **단순성 원칙 준수**: import/export 없이 script 태그 순서로 의존성 해결
- **순환 의존 없음**: 의존 그래프가 DAG 구조

### 검증 결과

- `npm test`: 23 CLI + 50 DOM = 73 테스트 전부 PASS
- 기존 테스트 코드 수정 0줄 (test-logic.js, test-dom.js 변경 없음)

---

## ADR-022: A-Tier2 Agent 3 경량화 — 교차 검증 위임

**날짜**: 2026-02-13
**상태**: 적용 완료
**관련 커밋**: `0662117`

### 맥락

릴리스 전 전수 검증(A+B+C+D Tier 2, 9 에이전트) 실행 결과, A-Tier2 Agent 3(CLAUDE.md + README.md 검증)이 병목으로 확인되었다.

| 지표 | A3 | 9개 평균 | 배율 |
|------|---:|--------:|-----:|
| Tool 호출 | 22회 | 11.8회 | 1.9x |
| 소요시간 | 107s | 58.9s | 1.8x |
| 토큰 | 48,665 | 41,662 | 1.2x |

**병목 원인**: A3가 함수 카운트(Grep), 테스트 수 확인(Read), 파일 존재(Glob), package.json 검증 등을 **독자적으로** 수행하면서 Tool 호출이 과다하게 발생. 이 중 상당수는 다른 에이전트가 이미 읽는 파일에서 수행 가능한 작업이었다.

### 결정

#### 1. 교차 검증 위임 (A3 → A1, A5)

A3에서 다른 에이전트가 이미 읽는 파일과 겹치는 검증 항목을 위임한다.

| 위임 항목 | 기존 담당 | 신규 담당 | 근거 |
|-----------|----------|----------|------|
| 함수 카운트(34개) | A3 (Grep js/) | **A1** | A1이 tech.md + js/*.js 이미 읽음 |
| 테스트 수(73=23+50) | A3 (Read test/README.md) | **A5** | A5가 test/README.md 이미 읽음 |
| package.json 스크립트 | A3 (Read package.json) | **A5** | A5가 package.json 이미 읽음 |
| 파일 존재 (Glob) | A3 (Glob) | **A1** | A1이 tech.md 파일 구조 이미 검증 |

**A3 잔여 범위**: CLAUDE.md 파일 타입 분류 테이블(Glob) + README.md 내용 정확성

#### 2. A3 프롬프트 최적화

| 기법 | 내용 | 효과 |
|------|------|------|
| 기대값 명시 | js/ 모듈 7개, 파일 타입 분류 수를 프롬프트에 포함 | 탐색 Grep 제거 |
| 배치 가이드 | CLAUDE.md + README.md 병렬 Read → Glob 1~2회 → 완료 | Tool 호출 최소화 |
| 범위 명시 | "API 테이블 검증은 A1 담당" 등 비범위 명시 | 불필요 탐색 방지 |

#### 3. A1, A5 확장

| 에이전트 | 추가 비교 소스 | 추가 검증 항목 |
|----------|-------------|-------------|
| A1 | CLAUDE.md(API 테이블) | 함수 목록 34개가 tech.md와 이름·개수 일치하는지 |
| A5 | CLAUDE.md(수치) | 테스트 수 기대값(73) + package.json 스크립트 참조 일치 |

### 사유

- **병목 해소**: A3가 9개 에이전트 중 유일한 이상치(1.8x 시간)였고, 원인은 다른 에이전트와 중복되는 파일 탐색
- **토큰 중립**: A3 감소(-14K) ≈ A1 증가(+7.6K) + A5 증가(+3.7K). 총 토큰은 -3% 소폭 감소
- **소스 겹침 최소화**: A1은 이미 js/*.js를 읽으므로 CLAUDE.md API 테이블 1개 추가(겹침 ≤1). A5는 이미 package.json을 읽으므로 CLAUDE.md Grep 1회 추가

### 검증 결과

최적화 전후 실측 비교 (Sonnet 모델, 릴리스 전 전수 검증):

**A3 (핵심 대상)**:

| 지표 | 최적화 전 | 최적화 후 | 개선 |
|------|----------:|----------:|-----:|
| 토큰 | 48,665 | 34,504 | **-29%** |
| Tool 호출 | 22회 | 8회 | **-64%** |
| 소요시간 | 107s | 27s | **-75%** |

**전체 시스템**:

| 지표 | 최적화 전 | 최적화 후 | 개선 |
|------|----------:|----------:|-----:|
| 총 토큰 | 374,959 | 364,046 | **-2.9%** |
| 총 Tool 호출 | 106회 | 72회 | **-32%** |
| Wall time 중앙값 | ~107s | ~74s | **-31%** |

**A1 분산 검증** (동일 프롬프트 4회 실행):
- 소요시간: 41s, 69s, 104s, 108s (σ=27s) → A1은 분산 문제이며 구조적 병목 아님 확인

### 검토한 대안

- **A3 분할 (A3a + A3b)**: CLAUDE.md / README.md 각각 별도 에이전트. 고정 오버헤드 2배(~20K) 증가하여 토큰 비효율
- **A3 프롬프트 최적화만**: 위임 없이 기대값 명시 + 배치 가이드만 적용. Tool 호출은 줄지만 소스 겹침(js/ Grep)이 A1과 중복 유지
- **A3 폐지 (A1+A5 흡수)**: A3 범위를 완전히 A1과 A5에 분배. A3 잔여 범위(파일 타입 테이블 + README.md)가 ~25K로 최소 작업량 기준 경계에 있어 유지 결정
