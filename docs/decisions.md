# 아키텍처 결정 기록 (Architecture Decision Records)

프로젝트의 주요 설계 결정과 그 사유를 기록합니다.

> 과거 ADR: [decisions_001_010.md](./decisions_001_010.md) (ADR-001~010) | [decisions_011_020.md](./decisions_011_020.md) (ADR-011~020)

---

## 목차

| # | 결정 | 상태 | 날짜 |
|---|------|------|------|
| [021](#adr-021) | app.js 모듈 분할 + CSS @media 인라인 배치 | 적용 완료 | 2026-02-13 |
| [022](#adr-022) | A-Tier2 Agent 3 경량화 — 교차 검증 위임 | 적용 완료 | 2026-02-13 |

---

## ADR-021: app.js 모듈 분할 + CSS @media 인라인 배치

> 날짜: 2026-02-13 | 상태: 적용 완료

### 맥락

`app.js`가 단일 파일 757줄, 34함수로 구성. 테마 함수 하나를 수정해도 전체 757줄을 읽어야 하며, 에이전트 작업 시 토큰 비효율 발생.

### 결정

**JS**: `app.js`를 7개 모듈로 분할. ES modules 불사용, 전역 함수 + `<script>` 태그 순서 로딩.

| 모듈 | 역할 | 의존 |
|------|------|------|
| `utils.js` | 상수 + 범용 유틸리티 | 없음 |
| `theme.js` | 테마/다크모드 | THEME_KEY (utils) |
| `exclude.js` | 번호 제외 기능 | EXCLUDED_KEY (utils) |
| `lottery.js` | 추첨 로직 + 결과 표시 | copyToClipboard (utils) |
| `history.js` | 이력 관리 (Local + Supabase) | STORAGE_KEY, MAX_HISTORY, generateUUID, showToast (utils) |
| `auth.js` | 인증 (Supabase) | showToast (utils), displayHistory (history) |
| `app.js` | 진입점 (메인 함수 + 초기화) | 전부 |

**Node.js 테스트 호환**: `app.js`에서 `require` → `Object.assign(global, utils)` → 다른 모듈 require → 통합 export.

**CSS**: 파일 하단 단일 `@media` 블록을 각 컴포넌트 바로 아래에 인라인 배치. CSS 변수 블록(:root + dark) 연속 배치.

### 사유

- **토큰 효율**: 테마 수정 시 ~70줄만 읽기 (기존 757줄 → 91% 절감)
- **단순성 원칙 준수**: import/export 없이 script 태그 순서로 의존성 해결
- **순환 의존 없음**: 의존 그래프가 DAG 구조

### 검증 결과

- `npm test`: 23 CLI + 50 DOM = 73 테스트 전부 PASS
- 기존 테스트 코드 수정 0줄 (test-logic.js, test-dom.js 변경 없음)

---

## ADR-022: A-Tier2 Agent 3 경량화 — 교차 검증 위임

**날짜**: 2026-02-13
**상태**: 적용 완료
**관련 커밋**: `0662117`

### 맥락

릴리스 전 전수 검증(A+B+C+D Tier 2, 9 에이전트) 실행 결과, A-Tier2 Agent 3(CLAUDE.md + README.md 검증)이 병목으로 확인되었다.

| 지표 | A3 | 9개 평균 | 배율 |
|------|---:|--------:|-----:|
| Tool 호출 | 22회 | 11.8회 | 1.9x |
| 소요시간 | 107s | 58.9s | 1.8x |
| 토큰 | 48,665 | 41,662 | 1.2x |

**병목 원인**: A3가 함수 카운트(Grep), 테스트 수 확인(Read), 파일 존재(Glob), package.json 검증 등을 **독자적으로** 수행하면서 Tool 호출이 과다하게 발생. 이 중 상당수는 다른 에이전트가 이미 읽는 파일에서 수행 가능한 작업이었다.

### 결정

#### 1. 교차 검증 위임 (A3 → A1, A5)

A3에서 다른 에이전트가 이미 읽는 파일과 겹치는 검증 항목을 위임한다.

| 위임 항목 | 기존 담당 | 신규 담당 | 근거 |
|-----------|----------|----------|------|
| 함수 카운트(34개) | A3 (Grep js/) | **A1** | A1이 tech.md + js/*.js 이미 읽음 |
| 테스트 수(73=23+50) | A3 (Read test/README.md) | **A5** | A5가 test/README.md 이미 읽음 |
| package.json 스크립트 | A3 (Read package.json) | **A5** | A5가 package.json 이미 읽음 |
| 파일 존재 (Glob) | A3 (Glob) | **A1** | A1이 tech.md 파일 구조 이미 검증 |

**A3 잔여 범위**: CLAUDE.md 파일 타입 분류 테이블(Glob) + README.md 내용 정확성

#### 2. A3 프롬프트 최적화

| 기법 | 내용 | 효과 |
|------|------|------|
| 기대값 명시 | js/ 모듈 7개, 파일 타입 분류 수를 프롬프트에 포함 | 탐색 Grep 제거 |
| 배치 가이드 | CLAUDE.md + README.md 병렬 Read → Glob 1~2회 → 완료 | Tool 호출 최소화 |
| 범위 명시 | "API 테이블 검증은 A1 담당" 등 비범위 명시 | 불필요 탐색 방지 |

#### 3. A1, A5 확장

| 에이전트 | 추가 비교 소스 | 추가 검증 항목 |
|----------|-------------|-------------|
| A1 | CLAUDE.md(API 테이블) | 함수 목록 34개가 tech.md와 이름·개수 일치하는지 |
| A5 | CLAUDE.md(수치) | 테스트 수 기대값(73) + package.json 스크립트 참조 일치 |

### 사유

- **병목 해소**: A3가 9개 에이전트 중 유일한 이상치(1.8x 시간)였고, 원인은 다른 에이전트와 중복되는 파일 탐색
- **토큰 중립**: A3 감소(-14K) ≈ A1 증가(+7.6K) + A5 증가(+3.7K). 총 토큰은 -3% 소폭 감소
- **소스 겹침 최소화**: A1은 이미 js/*.js를 읽으므로 CLAUDE.md API 테이블 1개 추가(겹침 ≤1). A5는 이미 package.json을 읽으므로 CLAUDE.md Grep 1회 추가

### 검증 결과

최적화 전후 실측 비교 (Sonnet 모델, 릴리스 전 전수 검증):

**A3 (핵심 대상)**:

| 지표 | 최적화 전 | 최적화 후 | 개선 |
|------|----------:|----------:|-----:|
| 토큰 | 48,665 | 34,504 | **-29%** |
| Tool 호출 | 22회 | 8회 | **-64%** |
| 소요시간 | 107s | 27s | **-75%** |

**전체 시스템**:

| 지표 | 최적화 전 | 최적화 후 | 개선 |
|------|----------:|----------:|-----:|
| 총 토큰 | 374,959 | 364,046 | **-2.9%** |
| 총 Tool 호출 | 106회 | 72회 | **-32%** |
| Wall time 중앙값 | ~107s | ~74s | **-31%** |

**A1 분산 검증** (동일 프롬프트 4회 실행):
- 소요시간: 41s, 69s, 104s, 108s (σ=27s) → A1은 분산 문제이며 구조적 병목 아님 확인

### 검토한 대안

- **A3 분할 (A3a + A3b)**: CLAUDE.md / README.md 각각 별도 에이전트. 고정 오버헤드 2배(~20K) 증가하여 토큰 비효율
- **A3 프롬프트 최적화만**: 위임 없이 기대값 명시 + 배치 가이드만 적용. Tool 호출은 줄지만 소스 겹침(js/ Grep)이 A1과 중복 유지
- **A3 폐지 (A1+A5 흡수)**: A3 범위를 완전히 A1과 A5에 분배. A3 잔여 범위(파일 타입 테이블 + README.md)가 ~25K로 최소 작업량 기준 경계에 있어 유지 결정
