# 아키텍처 결정 기록 (Architecture Decision Records)

프로젝트의 주요 설계 결정과 그 사유를 기록합니다.

> 과거 ADR: [decisions_001_010.md](./decisions_001_010.md) (ADR-001~010) | [decisions_011_020.md](./decisions_011_020.md) (ADR-011~020)

---

## 목차

| # | 결정 | 상태 | 날짜 |
|---|------|------|------|
| [021](#adr-021) | app.js 모듈 분할 + CSS @media 인라인 배치 | 적용 완료 | 2026-02-13 |
| [022](#adr-022) | A-Tier2 Agent 3 경량화 — 교차 검증 위임 | 적용 완료 | 2026-02-13 |
| [023](#adr-023) | B-Tier2 에이전트 Bash 금지 — Read/Grep 전환 | 적용 완료 | 2026-02-13 |
| [024](#adr-024) | Tier 2 에이전트 병합 (9→5) + Haiku 혼합 | 적용 완료 | 2026-02-13 |

---

## ADR-021: app.js 모듈 분할 + CSS @media 인라인 배치

> 날짜: 2026-02-13 | 상태: 적용 완료

### 맥락

`app.js`가 단일 파일 757줄, 34함수로 구성. 테마 함수 하나를 수정해도 전체 757줄을 읽어야 하며, 에이전트 작업 시 토큰 비효율 발생.

### 결정

**JS**: `app.js`를 7개 모듈로 분할. ES modules 불사용, 전역 함수 + `<script>` 태그 순서 로딩.

| 모듈 | 역할 | 의존 |
|------|------|------|
| `utils.js` | 상수 + 범용 유틸리티 | 없음 |
| `theme.js` | 테마/다크모드 | THEME_KEY (utils) |
| `exclude.js` | 번호 제외 기능 | EXCLUDED_KEY (utils) |
| `lottery.js` | 추첨 로직 + 결과 표시 | copyToClipboard (utils) |
| `history.js` | 이력 관리 (Local + Supabase) | STORAGE_KEY, MAX_HISTORY, generateUUID, showToast (utils) |
| `auth.js` | 인증 (Supabase) | showToast (utils), displayHistory (history) |
| `app.js` | 진입점 (메인 함수 + 초기화) | 전부 |

**Node.js 테스트 호환**: `app.js`에서 `require` → `Object.assign(global, utils)` → 다른 모듈 require → 통합 export.

**CSS**: 파일 하단 단일 `@media` 블록을 각 컴포넌트 바로 아래에 인라인 배치. CSS 변수 블록(:root + dark) 연속 배치.

### 사유

- **토큰 효율**: 테마 수정 시 ~70줄만 읽기 (기존 757줄 → 91% 절감)
- **단순성 원칙 준수**: import/export 없이 script 태그 순서로 의존성 해결
- **순환 의존 없음**: 의존 그래프가 DAG 구조

### 검증 결과

- `npm test`: 23 CLI + 50 DOM = 73 테스트 전부 PASS
- 기존 테스트 코드 수정 0줄 (test-logic.js, test-dom.js 변경 없음)

---

## ADR-022: A-Tier2 Agent 3 경량화 — 교차 검증 위임

**날짜**: 2026-02-13
**상태**: 적용 완료
**관련 커밋**: `0662117`

### 맥락

릴리스 전 전수 검증(A+B+C+D Tier 2, 9 에이전트) 실행 결과, A-Tier2 Agent 3(CLAUDE.md + README.md 검증)이 병목으로 확인되었다.

| 지표 | A3 | 9개 평균 | 배율 |
|------|---:|--------:|-----:|
| Tool 호출 | 22회 | 11.8회 | 1.9x |
| 소요시간 | 107s | 58.9s | 1.8x |
| 토큰 | 48,665 | 41,662 | 1.2x |

**병목 원인**: A3가 함수 카운트(Grep), 테스트 수 확인(Read), 파일 존재(Glob), package.json 검증 등을 **독자적으로** 수행하면서 Tool 호출이 과다하게 발생. 이 중 상당수는 다른 에이전트가 이미 읽는 파일에서 수행 가능한 작업이었다.

### 결정

#### 1. 교차 검증 위임 (A3 → A1, A5)

A3에서 다른 에이전트가 이미 읽는 파일과 겹치는 검증 항목을 위임한다.

| 위임 항목 | 기존 담당 | 신규 담당 | 근거 |
|-----------|----------|----------|------|
| 함수 카운트(34개) | A3 (Grep js/) | **A1** | A1이 tech.md + js/*.js 이미 읽음 |
| 테스트 수(73=23+50) | A3 (Read test/README.md) | **A5** | A5가 test/README.md 이미 읽음 |
| package.json 스크립트 | A3 (Read package.json) | **A5** | A5가 package.json 이미 읽음 |
| 파일 존재 (Glob) | A3 (Glob) | **A1** | A1이 tech.md 파일 구조 이미 검증 |

**A3 잔여 범위**: CLAUDE.md 파일 타입 분류 테이블(Glob) + README.md 내용 정확성

#### 2. A3 프롬프트 최적화

| 기법 | 내용 | 효과 |
|------|------|------|
| 기대값 명시 | js/ 모듈 7개, 파일 타입 분류 수를 프롬프트에 포함 | 탐색 Grep 제거 |
| 배치 가이드 | CLAUDE.md + README.md 병렬 Read → Glob 1~2회 → 완료 | Tool 호출 최소화 |
| 범위 명시 | "API 테이블 검증은 A1 담당" 등 비범위 명시 | 불필요 탐색 방지 |

#### 3. A1, A5 확장

| 에이전트 | 추가 비교 소스 | 추가 검증 항목 |
|----------|-------------|-------------|
| A1 | CLAUDE.md(API 테이블) | 함수 목록 34개가 tech.md와 이름·개수 일치하는지 |
| A5 | CLAUDE.md(수치) | 테스트 수 기대값(73) + package.json 스크립트 참조 일치 |

### 사유

- **병목 해소**: A3가 9개 에이전트 중 유일한 이상치(1.8x 시간)였고, 원인은 다른 에이전트와 중복되는 파일 탐색
- **토큰 중립**: A3 감소(-14K) ≈ A1 증가(+7.6K) + A5 증가(+3.7K). 총 토큰은 -3% 소폭 감소
- **소스 겹침 최소화**: A1은 이미 js/*.js를 읽으므로 CLAUDE.md API 테이블 1개 추가(겹침 ≤1). A5는 이미 package.json을 읽으므로 CLAUDE.md Grep 1회 추가

### 검증 결과

최적화 전후 실측 비교 (Sonnet 모델, 릴리스 전 전수 검증):

**A3 (핵심 대상)**:

| 지표 | 최적화 전 | 최적화 후 | 개선 |
|------|----------:|----------:|-----:|
| 토큰 | 48,665 | 34,504 | **-29%** |
| Tool 호출 | 22회 | 8회 | **-64%** |
| 소요시간 | 107s | 27s | **-75%** |

**전체 시스템**:

| 지표 | 최적화 전 | 최적화 후 | 개선 |
|------|----------:|----------:|-----:|
| 총 토큰 | 374,959 | 364,046 | **-2.9%** |
| 총 Tool 호출 | 106회 | 72회 | **-32%** |
| Wall time 중앙값 | ~107s | ~74s | **-31%** |

**A1 분산 검증** (동일 프롬프트 4회 실행):
- 소요시간: 41s, 69s, 104s, 108s (σ=27s) → A1은 분산 문제이며 구조적 병목 아님 확인

### 검토한 대안

- **A3 분할 (A3a + A3b)**: CLAUDE.md / README.md 각각 별도 에이전트. 고정 오버헤드 2배(~20K) 증가하여 토큰 비효율
- **A3 프롬프트 최적화만**: 위임 없이 기대값 명시 + 배치 가이드만 적용. Tool 호출은 줄지만 소스 겹침(js/ Grep)이 A1과 중복 유지
- **A3 폐지 (A1+A5 흡수)**: A3 범위를 완전히 A1과 A5에 분배. A3 잔여 범위(파일 타입 테이블 + README.md)가 ~25K로 최소 작업량 기준 경계에 있어 유지 결정

---

## ADR-023: B-Tier2 에이전트 Bash 금지 — Read/Grep 전환

**날짜**: 2026-02-13
**상태**: 적용 완료
**관련 커밋**: `30fea1d`

### 맥락

ADR-022 적용 후 전수 검증(A+B+C+D Tier 2, 9 에이전트) 재실행 결과, B-Tier2(design.md ↔ style.css)가 새로운 병목으로 부상하였다.

| 지표 | B | 9개 평균 | 배율 |
|------|--:|--------:|-----:|
| Tool 호출 | 49회 | 12.1회 | 4.0x |
| 소요시간 | 289s | 41.0s | 7.0x |
| 토큰 | 52,917 | 43,384 | 1.2x |

**병목 원인**: B 에이전트가 CSS 변수 비교를 위해 Bash(grep/sed/diff/sort/wc)를 49회 호출. 파이프 조합으로 임시 파일 생성 → diff → 삭제 패턴을 반복하여 Tool 호출 오버헤드(~5-6s/회)가 누적되었다. 토큰 자체는 평균 수준(1.2x)으로, 시간 병목의 원인은 순수하게 Tool 호출 횟수였다.

### 결정

#### 1. Bash 금지 규칙

B-Tier2 프롬프트에 **Bash 사용 금지** 규칙 명시. Bash(grep/sed/diff) 대신 Read + Grep 도구만 사용하도록 제한.

| 기존 방식 | 신규 방식 |
|----------|----------|
| `grep -E "..." style.css \| sed ... \| sort -u` (Bash) | `Read(style.css)` → 모델이 직접 비교 |
| `diff .temp_a.txt .temp_b.txt` (Bash, 임시 파일) | `Read(design.md)` + `Read(style.css)` → 모델 내 교차 비교 |
| `sed -n '/selector/,/}/p' style.css` (Bash) | `Grep(pattern, style.css)` |

#### 2. 배치 가이드 + 기대값 명시

| 기법 | 내용 | 효과 |
|------|------|------|
| 배치 가이드 | design.md + style.css 병렬 Read(2회) → Grep 교차 검증 → 완료 | Tool 호출 최소화 |
| 기대값 명시 | CSS 변수 고유 42개, :root 42개, dark 19개, keyframes 4개, 480px | 탐색 Grep 제거 |
| Bash 금지 | "Bash 사용 금지" 프롬프트 명시 | 파이프라인 패턴 방지 |

### 사유

- **Tool 호출 오버헤드 지배적**: 토큰은 평균 1.2x인데 시간은 7.0x → 차이의 원인은 Tool 호출 횟수(49회 × ~5-6s)
- **Read가 Bash보다 효율적**: CSS 파일 전체를 1회 Read하면 모델이 내부적으로 비교 가능. Bash 파이프라인은 같은 파일을 부분적으로 여러 번 접근
- **임시 파일 제거**: Bash diff 패턴에서 필요했던 임시 파일(.temp_*.txt) 생성/삭제 사이클 완전 제거

### 검증 결과

최적화 전후 실측 비교 (Sonnet 모델):

**B-Tier2 (핵심 대상)**:

| 지표 | 최적화 전 | 최적화 후 | 개선 |
|------|----------:|----------:|-----:|
| 토큰 | 52,917 | 37,474 | **-29%** |
| Tool 호출 | 49회 | 3회 | **-94%** |
| 소요시간 | 289s | 24s | **-92%** |
| Bash 사용 | 22+회 | 0회 | **100% 제거** |

**전체 시스템 예측** (B 최적화 적용 시):

| 지표 | 최적화 전 | 예측 | 개선 |
|------|----------:|-----:|-----:|
| 총 Tool 호출 | 109회 | ~63회 | **-42%** |
| Wall time (병목) | 289s (B) | ~56s (C) | **-81%** |

### 검토한 대안

- **B 에이전트 분할 (B1 + B2)**: 변수 비교 / 컴포넌트 비교 분리. 고정 오버헤드 2배(~20K) 증가, 각각 ~17K로 최소 작업량(25K) 미달
- **Bash 허용 + 호출 수 제한**: "Bash 10회 이내" 지시. 에이전트가 제한을 준수하지 않을 위험 + Read 대비 여전히 비효율
- **Bash 파이프라인 최적화**: 여러 grep/sed를 단일 Bash 호출로 합치기. 호출 수는 줄지만 Read/Grep 전환 대비 복잡도 높고 임시 파일 패턴 유지

---

## ADR-024: Tier 2 에이전트 병합 (9→5) + Haiku 혼합

**날짜**: 2026-02-13
**상태**: 적용 완료

### 맥락

ADR-022, ADR-023 최적화 후에도 릴리스 전 전수 검증이 9개 에이전트, ~364K 토큰을 소비하였다. 소스 파일 중복 읽기 분석 결과, 총 토큰의 ~16%가 중복 파일 읽기에, ~25%가 에이전트 고정 오버헤드(~10K/개)에 사용됨을 확인하였다.

**소스 파일 중복 읽기 현황**:

| 파일 | 줄 수 | 읽는 에이전트 | 횟수 | 추정 낭비 |
|------|------:|-------------|:----:|----------:|
| js/*.js (7모듈) | 873 | A1, A2, C | 3 | ~20K |
| style.css | 801 | A1, A4, B | 3 | ~20K |
| index.html | 110 | A1, A2, A4, C | 4 | ~4.5K |
| design.md | 364 | A4, B | 2 | ~5K |
| spec.md | 219 | A2, C | 2 | ~3K |
| test-logic.js | 247 | A5, D1 | 2 | ~3K |
| test-dom.js | 203 | A5, D2 | 2 | ~2.5K |
| **합계** | | | | **~58K** |

### 결정

#### 1. 4건 에이전트 병합 (9→5)

| 병합 | 공유 소스 | 절감 근거 |
|------|----------|----------|
| **A2+C → A2** | spec.md + index.html + js/*.js (100% 겹침) | 중복 ~14.5K + 오버헤드 10K |
| **A4+B → B** | design.md + style.css | 중복 ~15K + 오버헤드 10K |
| **A3+A5 → A3** | CLAUDE.md (섹션) | 중복 ~3K + 오버헤드 10K |
| **D1+D2 → D** | 오버헤드만 | 오버헤드 10K |

**병합 후 구조**:

| 에이전트 | 모델 | 문서 | 비교 소스 |
|----------|------|------|----------|
| A1 | Sonnet | tech.md | js/*.js, style.css, index.html, CLAUDE.md(API) |
| A2 | Sonnet | spec.md | index.html, js/*.js (양방향: 문서 정확성 + 구현 준수 + ARIA) |
| A3 | Sonnet | CLAUDE.md(비API) + README.md + test/README.md | Glob, test files, package.json, CLAUDE.md(수치) |
| B | Sonnet | design.md | style.css, index.html (전수) |
| D | Sonnet | CLI + DOM/UI 테스트 통합 | test-logic.js, test-dom.js, app.js, test.html |

#### 2. 모델 통일 (Sonnet)

전 에이전트 Sonnet 사용. 초기에 A3, D를 Haiku로 운영하였으나, Haiku 오탐(D에서 테스트 미작성 vs 함수 미구현 혼동) 확인 후 정확도 우선으로 Sonnet 통일.

### 사유

- **중복 읽기 제거**: 전체 토큰의 16%(~58K)가 같은 파일을 여러 에이전트가 반복 읽는 데 소비. 특히 A2와 C는 소스 100% 동일
- **고정 오버헤드 절감**: 에이전트 4개 감소 × 10K = ~40K 절감
- **Sonnet 통일**: 초기 Haiku 혼합 운영 후 오탐 확인 → 정확도 우선으로 전 에이전트 Sonnet 통일
- **시간 제약 준수**: 병합으로 개별 에이전트 처리량 증가하나, 파일을 한 번만 읽으므로 예상 wall time +0~16% (20% 제약 이내)

### 실측 결과

**릴리스 전 전수 검증 (Haiku 혼합 시 실측)**:

| 지표 | 최적화 전 (ADR-023 후) | 실측 | 개선 |
|------|----------------------:|-----:|-----:|
| 에이전트 수 | 9 | 5 | **-44%** |
| 총 토큰 | ~364K | 238.6K | **-34%** |
| Wall time | ~56s (C) | 53.0s (B) | **-5%** |
| Tool 호출 | ~63회 | 56회 | **-11%** |

**개별 에이전트 실측 (Haiku 혼합 → Sonnet 통일)**:

| 에이전트 | Haiku 혼합 실측 | Sonnet 추정 | Tool 호출 | 시간 |
|----------|---------------:|-----------:|---------:|-----:|
| A1 (Sonnet) | 54.9K | 55K | 12 | 38.6s |
| A2 (Sonnet) | 39.7K | 40K | 9 | 22.4s |
| A3 (Haiku→Sonnet) | 42.4K | ~55K | 18 | 29.6s |
| B (Sonnet) | 41.7K | 42K | 3 | 53.0s |
| D (Haiku→Sonnet) | 60.0K | ~78K | 14 | 33.7s |
| **합계** | **238.6K** | **~270K** | **56** | **53.0s** |

> Sonnet 추정: Haiku 실측 × 1.3 (경험적 보정계수). A3, D의 정확한 Sonnet 토큰은 차기 실측 시 확인.

### 검토한 대안

- **A2+C 미병합 (3건 병합만)**: 안전하지만 가장 큰 중복(js/*.js 3중 읽기)이 미해소. ~315K (-13%)로 효과 제한적
- **A1+A2+C 메가 병합**: 중복 최대 제거. 그러나 소스 ~2,500줄 + 3방향 검증으로 예상 70-80s → 20% 시간 제약 초과
- **전체 Haiku**: 모든 에이전트에 Haiku 적용. ~30-35% 추가 절감이나 복합 검증(A1, A2, B) 정확도 저하 위험
- **증분 검증 (변경분만)**: 전수 대신 diff 기반 검증. 근본적 토큰 절감이나 릴리스 전 안전망 약화
